<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Management System - Complete Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .module-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            height: 100%;
        }
        .module-card:hover {
            transform: translateY(-5px);
        }
        .module-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            margin-bottom: 15px;
        }
        .ws-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
            display: inline-block;
        }
        .ws-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .btn-module {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .btn-module:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
            transform: scale(1.05);
        }
        .data-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-completed { background: #cce5ff; color: #004085; }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="main-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0">üè• Hospital Management System</h1>
                    <p class="text-muted mb-0">Comprehensive Healthcare Platform - All Modules Functional</p>
                </div>
                <div class="text-end">
                    <div class="mb-2">
                        <span class="ws-indicator" id="wsIndicator"></span>
                        <small id="wsStatus" class="ms-2">Disconnected</small>
                    </div>
                    <div id="userInfo" class="fw-bold">Not logged in</div>
                    <button class="btn btn-primary btn-sm mt-2" id="loginBtn">Login</button>
                    <button class="btn btn-secondary btn-sm mt-2" id="logoutBtn" style="display:none;">Logout</button>
                </div>
            </div>
        </div>

        <!-- Modules Grid -->
        <div class="row" id="modulesContainer">
            <!-- Electronic Medical Records -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="module-card">
                    <div class="module-icon">üìã</div>
                    <h5>Electronic Medical Records</h5>
                    <p class="text-muted small">Patient history, diagnoses, prescriptions, lab results</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-module btn-sm" onclick="window.HMS.showNewMedicalRecord()">‚ûï New Record</button>
                        <button class="btn btn-module btn-sm" onclick="window.HMS.showMedicalRecords()">üìÑ View Records</button>
                    </div>
                </div>
            </div>

            <!-- Billing & Revenue -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="module-card">
                    <div class="module-icon">üí∞</div>
                    <h5>Billing & Revenue</h5>
                    <p class="text-muted small">Invoices, payments, insurance claims, revenue tracking</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-module btn-sm" onclick="window.HMS.createInvoice()">‚ûï Create Invoice</button>
                        <button class="btn btn-module btn-sm" onclick="window.HMS.viewInvoices()">üìÑ View Invoices</button>
                    </div>
                </div>
            </div>

            <!-- Inventory Management -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="module-card">
                    <div class="module-icon">üì¶</div>
                    <h5>Inventory Management</h5>
                    <p class="text-muted small">Medical supplies, equipment, automatic reorder alerts</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-module btn-sm" onclick="window.HMS.addStock()">‚ûï Stock Entry</button>
                        <button class="btn btn-module btn-sm" onclick="window.HMS.checkLowStock()">‚ö†Ô∏è Low Stock Alert</button>
                    </div>
                </div>
            </div>

            <!-- Staff Management -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="module-card">
                    <div class="module-icon">üë•</div>
                    <h5>Staff Management</h5>
                    <p class="text-muted small">Scheduling, attendance, payroll, performance</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-module btn-sm" onclick="window.HMS.addSchedule()">‚ûï Add Schedule</button>
                        <button class="btn btn-module btn-sm" onclick="window.HMS.viewRoster()">üìÖ View Roster</button>
                    </div>
                </div>
            </div>

            <!-- Bed Management -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="module-card">
                    <div class="module-icon">üõèÔ∏è</div>
                    <h5>Bed Management</h5>
                    <p class="text-muted small">Bed availability, admissions, ward occupancy</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-module btn-sm" onclick="window.HMS.newAdmission()">‚ûï New Admission</button>
                        <button class="btn btn-module btn-sm" onclick="window.HMS.checkBeds()">üõèÔ∏è Available Beds</button>
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="module-card">
                    <div class="module-icon">üìä</div>
                    <h5>Analytics Dashboard</h5>
                    <p class="text-muted small">Real-time metrics, trends, KPIs, reports</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-module btn-sm" onclick="window.HMS.viewDashboard()">üìä View Dashboard</button>
                        <button class="btn btn-module btn-sm" onclick="window.HMS.exportReport()">üì• Export Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div class="modal fade" id="mainModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Modal Title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global HMS object to hold all functionality
        window.HMS = {
            // Configuration
            API_URL: window.location.hostname === 'localhost' 
                ? 'http://localhost:5700/api' 
                : 'https://hms-backend-final-morphvm-mkofwuzh.http.cloud.morph.so/api',
            WS_URL: window.location.hostname === 'localhost'
                ? 'ws://localhost:5700'
                : 'wss://hms-backend-final-morphvm-mkofwuzh.http.cloud.morph.so',
            
            // State
            authToken: localStorage.getItem('hms_token'),
            currentUser: null,
            ws: null,
            modal: null,

            // Initialize
            init() {
                console.log('Initializing HMS...');
                this.modal = new bootstrap.Modal(document.getElementById('mainModal'));
                this.setupEventListeners();
                this.connectWebSocket();
                this.checkAuth();
            },

            // Event Listeners
            setupEventListeners() {
                document.getElementById('loginBtn').addEventListener('click', () => this.showLogin());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
            },

            // WebSocket
            connectWebSocket() {
                try {
                    this.ws = new WebSocket(this.WS_URL);
                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                        document.getElementById('wsIndicator').classList.add('connected');
                        document.getElementById('wsStatus').textContent = 'Connected';
                    };
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleRealtimeUpdate(data);
                    };
                    this.ws.onclose = () => {
                        document.getElementById('wsIndicator').classList.remove('connected');
                        document.getElementById('wsStatus').textContent = 'Disconnected';
                        setTimeout(() => this.connectWebSocket(), 5000);
                    };
                } catch (error) {
                    console.error('WebSocket error:', error);
                }
            },

            handleRealtimeUpdate(data) {
                console.log('Realtime update:', data);
                this.showNotification(data.type, JSON.stringify(data.data));
            },

            // API Helper
            async apiCall(endpoint, method = 'GET', body = null) {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                
                if (this.authToken) {
                    options.headers['Authorization'] = `Bearer ${this.authToken}`;
                }
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                try {
                    const response = await fetch(`${this.API_URL}${endpoint}`, options);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'API Error');
                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    this.showNotification('Error', error.message, 'danger');
                    throw error;
                }
            },

            // Authentication
            checkAuth() {
                if (this.authToken) {
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'inline-block';
                    document.getElementById('userInfo').textContent = 'Logged in as: Admin';
                }
            },

            showLogin() {
                const content = `
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" value="admin@hospital.com" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" value="admin123" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                `;
                this.showModal('Login', content);
                
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.login();
                });
            },

            async login() {
                try {
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    const result = await this.apiCall('/auth/login', 'POST', { email, password });
                    
                    if (result.success) {
                        this.authToken = result.token;
                        this.currentUser = result.user;
                        localStorage.setItem('hms_token', this.authToken);
                        
                        document.getElementById('userInfo').textContent = `Logged in as: ${result.user.name}`;
                        document.getElementById('loginBtn').style.display = 'none';
                        document.getElementById('logoutBtn').style.display = 'inline-block';
                        
                        this.modal.hide();
                        this.showNotification('Success', 'Logged in successfully', 'success');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                }
            },

            logout() {
                this.authToken = null;
                this.currentUser = null;
                localStorage.removeItem('hms_token');
                
                document.getElementById('userInfo').textContent = 'Not logged in';
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'none';
                
                this.showNotification('Success', 'Logged out successfully', 'info');
            },

            // Module Functions
            async showMedicalRecords() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                try {
                    const data = await this.apiCall('/medical-records');
                    const content = `
                        <div class="data-table">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Patient</th>
                                        <th>Diagnosis</th>
                                        <th>Doctor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.records && data.records.length > 0 ? data.records.map(r => `
                                        <tr>
                                            <td>${new Date(r.created_at).toLocaleDateString()}</td>
                                            <td>${r.patient_name || 'N/A'}</td>
                                            <td>${r.diagnosis || 'N/A'}</td>
                                            <td>${r.doctor_name || 'N/A'}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4">No records found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                    this.showModal('Medical Records', content);
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            async showNewMedicalRecord() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                const content = `
                    <form id="medicalRecordForm">
                        <div class="mb-3">
                            <label class="form-label">Patient ID</label>
                            <input type="number" class="form-control" id="patientId" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Symptoms</label>
                            <textarea class="form-control" id="symptoms" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Diagnosis</label>
                            <input type="text" class="form-control" id="diagnosis" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Treatment</label>
                            <textarea class="form-control" id="treatment" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Record</button>
                    </form>
                `;
                this.showModal('New Medical Record', content);
                
                document.getElementById('medicalRecordForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const record = {
                            patient_id: document.getElementById('patientId').value,
                            symptoms: document.getElementById('symptoms').value,
                            diagnosis: document.getElementById('diagnosis').value,
                            treatment: document.getElementById('treatment').value,
                            prescription: '',
                            visit_type: 'consultation'
                        };
                        
                        await this.apiCall('/medical-records', 'POST', record);
                        this.modal.hide();
                        this.showNotification('Success', 'Medical record created successfully', 'success');
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });
            },

            async viewInvoices() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                try {
                    const data = await this.apiCall('/invoices');
                    const content = `
                        <div class="data-table">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Patient</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.invoices && data.invoices.length > 0 ? data.invoices.map(i => `
                                        <tr>
                                            <td>#${i.id}</td>
                                            <td>${i.patient_name || 'N/A'}</td>
                                            <td>$${i.total_amount}</td>
                                            <td><span class="status-badge status-${i.payment_status}">${i.payment_status}</span></td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4">No invoices found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                    this.showModal('Invoices', content);
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            createInvoice() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                const content = `
                    <form id="invoiceForm">
                        <div class="mb-3">
                            <label class="form-label">Patient ID</label>
                            <input type="number" class="form-control" id="invoicePatientId" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="invoiceDesc" value="Consultation" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-control" id="invoiceAmount" value="100" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Invoice</button>
                    </form>
                `;
                this.showModal('Create Invoice', content);
                
                document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const invoice = {
                            patient_id: document.getElementById('invoicePatientId').value,
                            items: [{
                                description: document.getElementById('invoiceDesc').value,
                                quantity: 1,
                                unit_price: parseFloat(document.getElementById('invoiceAmount').value)
                            }],
                            payment_method: 'cash'
                        };
                        
                        await this.apiCall('/invoices', 'POST', invoice);
                        this.modal.hide();
                        this.showNotification('Success', 'Invoice created successfully', 'success');
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });
            },

            async checkLowStock() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                try {
                    const data = await this.apiCall('/inventory/low-stock');
                    const content = `
                        <div class="data-table">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Reorder Level</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.items && data.items.length > 0 ? data.items.map(item => `
                                        <tr>
                                            <td>${item.item_name}</td>
                                            <td>${item.category}</td>
                                            <td class="text-danger fw-bold">${item.quantity}</td>
                                            <td>${item.reorder_level}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4">No low stock items</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                    this.showModal('Low Stock Alert', content);
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            addStock() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                const content = `
                    <form id="stockForm">
                        <div class="mb-3">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-control" id="category">
                                <option value="medicine">Medicine</option>
                                <option value="equipment">Equipment</option>
                                <option value="consumable">Consumable</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Stock</button>
                    </form>
                `;
                this.showModal('Add Stock', content);
                
                document.getElementById('stockForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const stock = {
                            item_name: document.getElementById('itemName').value,
                            category: document.getElementById('category').value,
                            quantity: parseInt(document.getElementById('quantity').value),
                            unit: 'units',
                            unit_price: 10
                        };
                        
                        await this.apiCall('/inventory', 'POST', stock);
                        this.modal.hide();
                        this.showNotification('Success', 'Stock added successfully', 'success');
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });
            },

            async viewRoster() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                try {
                    const data = await this.apiCall('/schedules');
                    const content = `
                        <div class="data-table">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Staff</th>
                                        <th>Department</th>
                                        <th>Shift</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.schedules && data.schedules.length > 0 ? data.schedules.map(s => `
                                        <tr>
                                            <td>${new Date(s.date).toLocaleDateString()}</td>
                                            <td>${s.staff_name}</td>
                                            <td>${s.department}</td>
                                            <td>${s.shift_start} - ${s.shift_end}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4">No schedules found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                    this.showModal('Staff Roster', content);
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            addSchedule() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                const content = `
                    <form id="scheduleForm">
                        <div class="mb-3">
                            <label class="form-label">Staff Name</label>
                            <input type="text" class="form-control" id="staffName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control" id="department" value="General" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="scheduleDate" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Shift Start</label>
                                <input type="time" class="form-control" id="shiftStart" value="08:00" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Shift End</label>
                                <input type="time" class="form-control" id="shiftEnd" value="16:00" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Schedule</button>
                    </form>
                `;
                this.showModal('Add Schedule', content);
                
                document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const schedule = {
                            staff_name: document.getElementById('staffName').value,
                            department: document.getElementById('department').value,
                            date: document.getElementById('scheduleDate').value,
                            shift_start: document.getElementById('shiftStart').value,
                            shift_end: document.getElementById('shiftEnd').value
                        };
                        
                        await this.apiCall('/schedules', 'POST', schedule);
                        this.modal.hide();
                        this.showNotification('Success', 'Schedule added successfully', 'success');
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });
            },

            async checkBeds() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                try {
                    const [beds, occupancy] = await Promise.all([
                        this.apiCall('/beds/available'),
                        this.apiCall('/beds/occupancy')
                    ]);
                    
                    const content = `
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-4 text-center">
                                    <h3>${occupancy.total_beds}</h3>
                                    <small>Total Beds</small>
                                </div>
                                <div class="col-4 text-center">
                                    <h3 class="text-success">${occupancy.available_beds}</h3>
                                    <small>Available</small>
                                </div>
                                <div class="col-4 text-center">
                                    <h3 class="text-danger">${occupancy.occupied_beds}</h3>
                                    <small>Occupied</small>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h6>Available Beds</h6>
                        <div class="data-table">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Bed #</th>
                                        <th>Ward</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${beds.beds && beds.beds.length > 0 ? beds.beds.map(bed => `
                                        <tr>
                                            <td>${bed.bed_number}</td>
                                            <td>${bed.ward}</td>
                                            <td><span class="badge bg-success">Available</span></td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="3">No available beds</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                    this.showModal('Bed Management', content);
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            newAdmission() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                const content = `
                    <form id="admissionForm">
                        <div class="mb-3">
                            <label class="form-label">Patient ID</label>
                            <input type="number" class="form-control" id="admissionPatientId" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ward</label>
                            <select class="form-control" id="ward">
                                <option value="General Ward">General Ward</option>
                                <option value="ICU">ICU</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Bed Number</label>
                            <input type="text" class="form-control" id="bedNumber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Admission Reason</label>
                            <textarea class="form-control" id="admissionReason" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Admission</button>
                    </form>
                `;
                this.showModal('New Admission', content);
                
                document.getElementById('admissionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const admission = {
                            patient_id: document.getElementById('admissionPatientId').value,
                            ward: document.getElementById('ward').value,
                            bed_number: document.getElementById('bedNumber').value,
                            admission_reason: document.getElementById('admissionReason').value,
                            doctor_name: 'Dr. Admin'
                        };
                        
                        await this.apiCall('/admissions', 'POST', admission);
                        this.modal.hide();
                        this.showNotification('Success', 'Admission created successfully', 'success');
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });
            },

            async viewDashboard() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                try {
                    const data = await this.apiCall('/analytics/dashboard');
                    const content = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h3>${data.metrics.total_patients}</h3>
                                        <small>Total Patients</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h3>${data.metrics.active_admissions}</h3>
                                        <small>Active Admissions</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h3>$${data.metrics.monthly_revenue.toFixed(2)}</h3>
                                        <small>Monthly Revenue</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h3>${data.metrics.upcoming_appointments}</h3>
                                        <small>Upcoming Appointments</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    this.showModal('Analytics Dashboard', content);
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            exportReport() {
                if (!this.authToken) {
                    this.showNotification('Error', 'Please login first', 'warning');
                    this.showLogin();
                    return;
                }
                
                const content = `
                    <form id="exportForm">
                        <div class="mb-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-control" id="reportType">
                                <option value="patients">Patients Report</option>
                                <option value="revenue">Revenue Report</option>
                                <option value="inventory">Inventory Report</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date From</label>
                            <input type="date" class="form-control" id="dateFrom" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date To</label>
                            <input type="date" class="form-control" id="dateTo" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Report</button>
                    </form>
                `;
                this.showModal('Export Report', content);
                
                document.getElementById('exportForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const params = {
                            report_type: document.getElementById('reportType').value,
                            date_from: document.getElementById('dateFrom').value,
                            date_to: document.getElementById('dateTo').value
                        };
                        
                        const data = await this.apiCall('/analytics/export', 'POST', params);
                        this.modal.hide();
                        this.showNotification('Success', `Report generated with ${data.metadata.record_count} records`, 'success');
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });
            },

            // Utility functions
            showModal(title, content) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalBody').innerHTML = content;
                this.modal.show();
            },

            showNotification(title, message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
                    <strong>${title}:</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 5000);
            }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing HMS...');
            window.HMS.init();
        });
    </script>
</body>
</html>
